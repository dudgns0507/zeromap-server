<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <meta name="theme-color" content="#000000"/>
    <link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/moonspam/NanumSquare/master/nanumsquare.css">
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"
            integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=a7093d3e465fb6d7f01ce619a01e6dd9"></script>
    <!--
      Notice the use of %PUBLIC_URL% in the tags above.
      It will be replaced with the URL of the `public` folder during the build.
      Only files inside the `public` folder can be referenced from the HTML.

      Unlike "/favicon.ico" or "favicon.ico", "%PUBLIC_URL%/favicon.ico" will
      work correctly both with client-side routing and a non-root public URL.
      Learn how to configure a non-root public URL by running `npm run build`.
    -->
    <title>재난지원금 지도</title>

    <style>
        body {
            padding: 0;
            margin: 0;
            font-family: 'NanumSquare', sans-serif !important;
        }

        textarea:focus, input:focus, button:focus {
            outline: none;
        }

        .no-drag {-ms-user-select: none; -moz-user-select: -moz-none; -webkit-user-select: none; -khtml-user-select: none; user-select:none;}

        #title {
            cursor: pointer;
            float: left;
            font-size: 20px;
            color: #238cfa;
            height: 30px;
            line-height: 30px;
            margin: 10px;
            font-weight: 900;
        }

        #map {
            width: 100vw;
            height: 100vh;
        }

        #ads {
            display: none;
            position: fixed;
            width: 320px;
            height: 50px;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            z-index: 1005;
        }

        #ads2 {
            position: fixed;
            width: 728px;
            height: 90px;
            left: 50%;
            transform: translateX(-50%);
            bottom: 0;
            z-index: 1005;
        }

        #list {
            position: fixed;
            bottom: calc(-60vh + 250px);
            width: 100%;
            height: calc(60vh);
            z-index: 997;
            background: #fff;
            border-top-left-radius: 40px;
            border-top-right-radius: 40px;
        　　-moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);

            -webkit-transition: -webkit-transform 1s;
            transition: transform 1s;
            -webkit-transform: translateY(0);
            transform: translateY(0);
        }

        #list.open {
            -webkit-transform: translateY(calc(-100% + 250px));
            transform: translateY(calc(-100% + 250px));
        }

        #info {
            position: fixed;
            bottom: 0;
            width: 100%;
            height: 250px;
            z-index: 998;
            background: #fff;
            border-top-left-radius: 40px;
            border-top-right-radius: 40px;
        　　-moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
        }

        #info-box {
            width: calc(100% - 60px);
            padding: 30px 30px 0 30px;
            max-width: 440px;
            margin: 0 auto;
        }

        #name {
            width: 100%;
            height: 30px;
            font-size: 1.6rem;
            font-weight: 900;
            text-overflow: ellipsis;
        }

        #category {
            width: 100%;
            height: 18px;
            font-size: 1rem;
            font-weight: 900;
            color: #999;
            margin-right: 10px;
            margin-top: 5px;
            text-align: right;
        }

        #address-box {
            width: 100%;
            height: 32px;
            line-height: 32px;
            margin-top: 10px;
        }

        #address {
            width: calc(100% - 60px);
            font-size: 1.1rem;
            font-weight: 300;
            color: #000;
            text-decoration: underline;
            cursor: pointer;
        }

        #report-warn {
            display: none;
            width: 100%;
            font-size: 1rem;
            font-weight: 900;
            color: #f5463d;
            margin-top: 5px;
            text-align: center;
        }

        #report {
            float: right;
            width: 60px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border: 1px solid #999;
            border-radius: 25px;
            cursor: pointer;
        }

        #popup {
            display: none;
            position: fixed;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
        }

        #close-area {
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #popup-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translateX(-50%) translateY(-50%);
            width: calc(100% - 80px);
            max-width: 400px;
            height: 340px;
            padding: 30px;
            border-radius: 30px;
            background: #fff;
        　　-moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            z-index: 1001;
        }

        #report-select {
            width: 100%;
            height: 30px;
            line-height: 30px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        #report-text {
            width: calc(100% - 7px);
            height: 140px;
            border-radius: 5px;
            margin-bottom: 10px;
        }

        #report-btn {
            width: 100%;
            height: 40px;
            border-radius: 5px;
            background: #238cfa;
            font-weight: 900;
            font-size: 16px;
            color: #fff;
        }

        .popup-title {
            font-weight: 500;
            font-size: 1.5rem;
            margin-bottom: 20px;
        }

        .popup-subtitle {
            font-weight: 500;
            font-size: 0.95rem;
            margin-left: 5px;
            margin-bottom: 5px;
        }

        #head {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 90px;
            background: #fff;
            z-index: 1002;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
        　　-moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
        }

        #tag-scroll {
            width: 100%;
            height: 40px;
            overflow-y: auto;
            scroll-direction: horizontal;
            -ms-overflow-style: none; /* IE and Edge */
            scrollbar-width: none; /* Firefox */
        }

        #tag-scroll::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera*/
        }

        #tag-box {
            width: 700px;
            height: 40px;
        }

        .tag {
            cursor: pointer;
            float: left;
            width: auto;
            height: 20px;
            line-height: 20px;
            margin: 0 10px;
            font-size: 14px;
            border: 1px solid #777;
            color: #777;
            border-radius: 20px;
            padding: 5px 15px;
        }

        .tag.active {
            border: 1px solid #238cfa;
            color: #238cfa;
        }

        #search {
            float: left;
            width: calc(100% - 120px);
            height: 30px;
            border-radius: 30px;
            background: #eee;
            margin: 10px 10px;
            padding: 0 10px;
            border: 0;
            color: #000;
        }

        #search-btn {
            cursor: pointer;
            position: fixed;
            left: 50%;
            top: 100px;
            transform: translateX(-50%);
            width: 140px;
            height: 32px;
            line-height: 32px;
            text-align: center;
            font-size: 15px;
            border: 3px solid #238cfa;
            border-radius: 20px;
            background: #fff;
            z-index: 1002;
        　　-moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
        }

        #list-close-btn {
            cursor: pointer;
            position: fixed;
            left: 50%;
            bottom: calc(60vh - 60px);
            transform: translateX(-50%);
            width: 100px;
            height: 40px;
            line-height: 40px;
            text-align: center;
            font-size: 20px;
            border-radius: 20px;
            background: #fff;
            z-index: 1002;
        　　-moz-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            -webkit-box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
            box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.3);
        }
        
        @media (min-width: 320px) and (max-width: 767px) {
            #ads {
                display: block;
            }
            
            #ads2 {
                display: none;
            }
        }
    </style>
</head>
<body>
<div id="root">
    <div id="popup">
        <div id="close-area" onclick="closePopup()">

        </div>
        <div id="popup-box">
            <div class="popup-title">제보하기</div>
            <div class="popup-subtitle">제보 종류 선택</div>
            <select id="report-select">
                <option value="제로페이 사용불가">제로페이 사용불가</option>
                <option value="오류 제보">오류 제보</option>
                <option value="기타">기타</option>
            </select>
            <div class="popup-subtitle">내용</div>
            <textarea id="report-text"></textarea>
            <button id="report-btn" onclick="sendReport()">제보</button>
        </div>
    </div>
    <div id="head">
        <span id="title" onclick="location.reload()">제로맵</span>
        <input id="search" placeholder="검색">
        <div id="tag-scroll">
            <div id="tag-box" class="no-drag">
                <div class="tag active" onclick="selectTag(1);">전체</div>
                <div class="tag" onclick="selectTag(2);">카페</div>
                <div class="tag" onclick="selectTag(3);">편의점/마트</div>
                <div class="tag" onclick="selectTag(4);">음식점</div>
                <div class="tag" onclick="selectTag(5);">디저트</div>
                <div class="tag" onclick="selectTag(6);">병원/약국</div>
                <div class="tag" onclick="selectTag(7);">의류</div>
            </div>
        </div>
    </div>
    <div id="search-btn" onclick="research()">
        현 지도에서 재검색
    </div>
    <div id="map">

    </div>
{#    <div id="list-btn" onclick="openList()">#}
{#        목록#}
{#    </div>#}
    <div id="info">
        <div id="info-box">
            <div id="name"></div>
            <div id="category"></div>
            <div id="address-box">
                <span id="address" onclick="openMap()"></span>
                <div id="report" onclick="openPopup()">제보</div>
            </div>
            <div id="report-warn">제로페이 사용불가 제보가 들어온 업체입니다.<br>방문 전 연락하여 확인 부탁드립니다.</div>
        </div>
    </div>
    <div id="list">
        <div id="list-close-btn" onclick="closeList()">
            숨기기
        </div>
    </div>
    <div id="ads">
        <ins class="kakao_ad_area" style="display:none;"
             data-ad-unit="DAN-1iv3uhu3tflnp"
             data-ad-width="320"
             data-ad-height="50"></ins>
    </div>
    <div id="ads2">
        <ins class="kakao_ad_area" style="display:none;"
            data-ad-unit    = "DAN-qecnqkoesi7s"
            data-ad-width   = "728"
            data-ad-height  = "90"></ins>
    </div>
    <script type="text/javascript" src="//t1.daumcdn.net/kas/static/ba.min.js" async></script>
</div>
<script>
    let id;
    let stores;
    let markerPositions = [];
    let markers = [];
    let map;
    let currentMarker;
    let lastMarker;
    let selectStore;
    let c = ["전체"];
    let tagList = ["카페", "편의점/마트", "음식점", "디저트", "병원/약국", "의류"];

    document.getElementById("search").addEventListener('keypress', press);

    initMap();
    getCurrentLocation();

    function initMap() {
        let container = document.getElementById('map');
        let options = {
            center: new window.kakao.maps.LatLng(33.450701, 126.570667),
            level: 2
        };

        map = new window.kakao.maps.Map(container, options);
    }

    function research() {
        let latlng = map.getCenter();

        if(document.getElementById("search").value === "" && c[0] === '전체')
            getStore(latlng.getLat(), latlng.getLng());
        else
            searchStore(latlng.getLat(), latlng.getLng());
    }

    function selectTag(i) {
        let tags = document.getElementsByClassName("tag");
        if(i === 1 && tags[0].classList.contains("active") === false) {
            for (let i = 1; i < tags.length; i++) {
                tags[i].classList.remove("active");
            }
            tags[0].classList.add("active");

            c = [];
            c.push("전체");
        } else if(i === 1) {
            tags[0].classList.remove("active");
            c = [];
        } else {
            if(tags[i - 1].classList.contains("active") === false) {
                if(tags[0].classList.contains("active") === true)
                    c.splice(c.indexOf("전체"), 1);

                tags[i - 1].classList.add("active");
                tags[0].classList.remove("active");

                c.push(tagList[i - 2]);
            } else {
                tags[i - 1].classList.remove("active");
                c.splice(c.indexOf(tagList[i - 2]), 1);
            }
        }

        let latlng = map.getCenter();
        searchStore(latlng.getLat(), latlng.getLng());
    }
    
    function press(e) {
        if(e.keyCode === 13) {
            let latlng = map.getCenter();
            searchStore(latlng.getLat(), latlng.getLng());
        }
    }

    function getCurrentLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                getStore(position.coords.latitude, position.coords.longitude);

                let markerPosition = new kakao.maps.LatLng(position.coords.latitude, position.coords.longitude);

                let imageSrc = 'https://xn--jj0bx2chw5adzab0f.com/static/image/dot.png';
                let imageSize = new kakao.maps.Size(30, 30);
                let imageOption = {offset: new kakao.maps.Point(15, 15)};

                let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
                currentMarker = new kakao.maps.Marker({
                    position: markerPosition,
                    image: markerImage
                });

                currentMarker.setMap(map);
                map.setCenter(markerPosition);
            }, function (error) {
                console.error(error);
            }, {
                enableHighAccuracy: false,
                maximumAge: 0,
                timeout: Infinity
            });
        } else {
            alert('GPS를 지원하지 않습니다');
        }
    }

    function getStore(lat, lng) {
        $.ajax({
            url: '/api/store',
            type: 'POST',
            dataType: "JSON",
            data: {
                lat: lat,
                lng: lng,
            },
            success: function (response) {
                if (response.code === 200) {
                    for (let i = 0; i < markers.length; i++) {
                        markers[i].setMap(null);
                    }
                    markers = [];
                    markerPositions = [];

                    stores = response.stores;

                    for (let i = 0; i < stores.length; i++) {
                        markerPositions.push({
                            title: stores[i].id,
                            latlng: new kakao.maps.LatLng(stores[i].lat, stores[i].lng),
                            clickable: true
                        });
                    }

                    for (let i = 0; i < markerPositions.length; i++) {
                        let imageSrc = 'https://xn--jj0bx2chw5adzab0f.com/static/image/marker1.png';
                        let imageSize = new kakao.maps.Size(19.75, 32);
                        let imageOption = {offset: new kakao.maps.Point(9.875, 32)};

                        let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

                        let marker = new kakao.maps.Marker({
                            map: map,
                            position: markerPositions[i].latlng,
                            title: markerPositions[i].title,
                            image: markerImage
                        });

                        kakao.maps.event.addListener(marker, 'click', function () {
                            if(lastMarker !== undefined)
                                changeMarker(lastMarker, 1);
                            changeMarker(marker, 2);

                            lastMarker = marker;

                            for (let i = 0; i < stores.length; i++) {
                                if(stores[i].id == marker.mc) {
                                    selectStore = stores[i];
                                    document.getElementById("name").innerText = stores[i].name;
                                    document.getElementById("address").innerText = stores[i].address;
                                    document.getElementById("category").innerText = stores[i].category;

                                    if(stores[i].report === 1) {
                                        document.getElementById("report-warn").style.display = "block";
                                    } else {
                                        document.getElementById("report-warn").style.display = "none";
                                    }
                                    break;
                                }
                            }
                        });
                        markers.push(marker);
                    }

                    if(stores.length > 0) {
                        changeMarker(markers[0], 2);

                        lastMarker = markers[0];

                        selectStore = stores[0];
                        document.getElementById("name").innerText = stores[0].name;
                        document.getElementById("address").innerText = stores[0].address;
                        document.getElementById("category").innerText = stores[0].category;

                        if (stores[0].report === 1) {
                            document.getElementById("report-warn").style.display = "block";
                        } else {
                            document.getElementById("report-warn").style.display = "none";
                        }
                    } else {
                        document.getElementById("name").innerText = "";
                        document.getElementById("address").innerText = "";
                        document.getElementById("category").innerText = "";
                    }
                }
            },
            error: function (error) {
            }
        });
    }

    function searchStore(lat, lng) {
        $.ajax({
            url: '/api/search/store',
            type: 'POST',
            dataType: "JSON",
            data: {
                q: document.getElementById("search").value,
                c: c,
                lat: lat,
                lng: lng,
            },
            success: function (response) {
                if (response.code === 200) {
                    for (let i = 0; i < markers.length; i++) {
                        markers[i].setMap(null);
                    }
                    markers = [];
                    markerPositions = [];

                    stores = response.stores;

                    for (let i = 0; i < stores.length; i++) {
                        markerPositions.push({
                            title: stores[i].id,
                            latlng: new kakao.maps.LatLng(stores[i].lat, stores[i].lng),
                            clickable: true
                        });
                    }

                    for (let i = 0; i < markerPositions.length; i++) {
                        let imageSrc = 'https://xn--jj0bx2chw5adzab0f.com/static/image/marker1.png';
                        let imageSize = new kakao.maps.Size(19.75, 32);
                        let imageOption = {offset: new kakao.maps.Point(9.875, 32)};

                        let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);

                        let marker = new kakao.maps.Marker({
                            map: map,
                            position: markerPositions[i].latlng,
                            title: markerPositions[i].title,
                            image: markerImage
                        });

                        kakao.maps.event.addListener(marker, 'click', function () {
                            if(lastMarker !== undefined)
                                changeMarker(lastMarker, 1);
                            changeMarker(marker, 2);

                            lastMarker = marker;

                            for (let i = 0; i < stores.length; i++) {
                                if(stores[i].id == marker.mc) {
                                    selectStore = stores[i];
                                    document.getElementById("name").innerText = stores[i].name;
                                    document.getElementById("address").innerText = stores[i].address;
                                    document.getElementById("category").innerText = stores[i].category;

                                    if(stores[i].report === 1) {
                                        document.getElementById("report-warn").style.display = "block";
                                    } else {
                                        document.getElementById("report-warn").style.display = "none";
                                    }
                                    break;
                                }
                            }
                        });
                        markers.push(marker);
                    }

                    if(stores.length > 0) {
                        changeMarker(markers[0], 2);

                        lastMarker = markers[0];

                        selectStore = stores[0];
                        document.getElementById("name").innerText = stores[0].name;
                        document.getElementById("address").innerText = stores[0].address;
                        document.getElementById("category").innerText = stores[0].category;

                        if (stores[0].report === 1) {
                            document.getElementById("report-warn").style.display = "block";
                        } else {
                            document.getElementById("report-warn").style.display = "none";
                        }
                    } else {
                        document.getElementById("name").innerText = "";
                        document.getElementById("address").innerText = "";
                        document.getElementById("category").innerText = "";
                    }
                }
            },
            error: function (error) {
            }
        });
    }
    
    function openList() {
        document.getElementById("list").style.zIndex = "1003";
        document.getElementById("list").classList.add("open");
    }

    function closeList() {
        document.getElementById("list").classList.remove("open");
        setTimeout(function() {
            document.getElementById("list").style.zIndex = "997";
        }, 1000);
    }

    function changeMarker(marker, flag) {
        let imageSrc = 'https://xn--jj0bx2chw5adzab0f.com/static/image/marker1.png';

        if(flag === 2) {
            imageSrc = 'https://xn--jj0bx2chw5adzab0f.com/static/image/marker2.png';
        }

        let imageSize = new kakao.maps.Size(19.75, 32);
        let imageOption = {offset: new kakao.maps.Point(9.875, 32)};

        let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
        marker.setImage(markerImage);
    }

    function setLocationWatcher() {
        const options = {
            enableHighAccuracy: false,
            timeout: 5000,
            maximumAge: 0
        };

        id = navigator.geolocation.watchPosition(success, error, options);
    }

    function success(pos) {
        let markerPosition = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);

        let imageSrc = 'https://xn--jj0bx2chw5adzab0f.com/static/image/dot.png';
        let imageSize = new kakao.maps.Size(30, 30);
        let imageOption = {offset: new kakao.maps.Point(15, 15)};

        let markerImage = new kakao.maps.MarkerImage(imageSrc, imageSize, imageOption);
        currentMarker = new kakao.maps.Marker({
            position: markerPosition,
            image: markerImage
        });

        currentMarker.setPosition(markerPosition);
    }

    function error(err) {
        console.warn('ERROR(' + err.code + '): ' + err.message);
    }
    
    function openMap() {
        let address = document.getElementById("address").innerText;
        window.open("https://map.kakao.com/link/search/" + address);
    }

    const setCookie = function (name, value, day) {
        let date = new Date();
        date.setTime(date.getTime() + day * 60 * 60 * 24 * 1000);
        document.cookie = name + '=' + value + ';expires=' + date.toUTCString() + ';path=/';
    };

    const getCookie = function (name) {
        let value = document.cookie.match('(^|;) ?' + name + '=([^;]*)(;|$)');
        return value ? value[2] : null;
    };

    const deleteCookie = function (name) {
        let date = new Date();
        document.cookie = name + "= " + "; expires=" + date.toUTCString() + "; path=/";
    };

    function openPopup() {
        document.getElementById("popup").style.display = "block";
    }

    function closePopup() {
        document.getElementById("popup").style.display = "none";
    }

    function sendReport() {
        let id = 0;

        if(selectStore !== undefined)
            id = selectStore.id;

        $.ajax({
            url: '/api/report',
            type: 'POST',
            dataType: "JSON",
            data: {
                id: id,
                title: document.getElementById("report-select").value,
                text: document.getElementById("report-text").value
            },
            success: function (response) {
                if (response.code === 200) {
                    document.getElementById("report-text").value = "";
                    closePopup();
                    alert("정상적으로 제보되었습니다. 감사합니다.");
                }
            },
            error: function (error) {
            }
        });
    }
</script>
</body>
</html>
